
/**
  ******************************************************************************
  * @file           : fir_filtre
  * @brief          :
  ******************************************************************************
  */

/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include "cmsis_os.h"
#include "myfir.h"


//#define MOVING_AVG_FILRE

static float FIR_IMPULSE_RESPONSE[FIR_FILTRE_LENGTH];


#if 0
float h[N] = {
-7.7778E-05,-4.5082E-04,-7.0190E-04,-7.2410E-04,-4.4774E-04,1.1199E-04,
8.1364E-04,1.3914E-03,1.5278E-03,9.9168E-04,-2.0934E-04,-1.7396E-03,
-2.9842E-03,-3.2568E-03,-2.1137E-03,3.5521E-04,3.4077E-03,5.8120E-03,
6.2871E-03,4.0844E-03,-5.2748E-04,-6.1229E-03,-1.0470E-02,-1.1328E-02,
-7.4363E-03,6.9992E-04,1.0603E-02,1.8417E-02,2.0214E-02,1.3615E-02,
-8.4620E-04,-1.9224E-02,-3.4839E-02,-4.0093E-02,-2.8914E-02,9.4400E-04,
4.6573E-02,1.0010E-01,1.5048E-01,1.8638E-01,1.9939E-01,1.8638E-01,
1.5048E-01,1.0010E-01,4.6573E-02,9.4400E-04,-2.8914E-02,-4.0093E-02,
-3.4839E-02,-1.9224E-02,-8.4620E-04,1.3615E-02,2.0214E-02,1.8417E-02,
1.0603E-02,6.9992E-04,-7.4363E-03,-1.1328E-02,-1.0470E-02,-6.1229E-03,
-5.2748E-04,4.0844E-03,6.2871E-03,5.8120E-03,3.4077E-03,3.5521E-04,
-2.1137E-03,-3.2568E-03,-2.9842E-03,-1.7396E-03,-2.0934E-04,9.9168E-04,
1.5278E-03,1.3914E-03,8.1364E-04,1.1199E-04,-4.4774E-04,-7.2410E-04,
-7.0190E-04,-4.5082E-04,-7.7778E-05
};
#endif




#if 0  /*High pass 30hz no windwos*/
float h[N] = {
7.7959E-05,6.0204E-04,-4.8590E-04,-3.9210E-04,8.8673E-04,-1.1216E-04,
-1.1121E-03,9.4954E-04,8.4350E-04,-1.9053E-03,2.0952E-04,2.4346E-03,
-2.0072E-03,-1.8321E-03,3.9427E-03,-3.5531E-04,-4.8845E-03,3.8522E-03,
3.6019E-03,-7.4021E-03,5.2737E-04,8.9918E-03,-6.8367E-03,-6.6062E-03,
1.3102E-02,-6.9950E-04,-1.5959E-02,1.1845E-02,1.1993E-02,-2.3337E-02,
8.4548E-04,2.9669E-02,-2.2062E-02,-2.4191E-02,4.8238E-02,-9.4305E-04,
-7.3733E-02,6.2398E-02,9.2302E-02,-3.0283E-01,4.0128E-01,-3.0283E-01,
9.2302E-02,6.2398E-02,-7.3733E-02,-9.4305E-04,4.8238E-02,-2.4191E-02,
-2.2062E-02,2.9669E-02,8.4548E-04,-2.3337E-02,1.1993E-02,1.1845E-02,
-1.5959E-02,-6.9950E-04,1.3102E-02,-6.6062E-03,-6.8367E-03,8.9918E-03,
5.2737E-04,-7.4021E-03,3.6019E-03,3.8522E-03,-4.8845E-03,-3.5531E-04,
3.9427E-03,-1.8321E-03,-2.0072E-03,2.4346E-03,2.0952E-04,-1.9053E-03,
8.4350E-04,9.4954E-04,-1.1121E-03,-1.1216E-04,8.8673E-04,-3.9210E-04,
-4.8590E-04,6.0204E-04,7.7959E-05
};
#endif


#if 0
/*FIR high pass blackman 30hz windows */
float h[N] = {
-1.3513E-20,4.1111E-06,-1.2698E-05,-2.1534E-05,7.9458E-05,-1.4254E-05,
-1.8376E-04,1.9260E-04,2.0192E-04,-5.2359E-04,6.4783E-05,8.3453E-04,
-7.5418E-04,-7.4799E-04,1.7367E-03,-1.6787E-04,-2.4630E-03,2.0642E-03,
2.0431E-03,-4.4292E-03,3.3179E-04,5.9299E-03,-4.7123E-03,-4.7459E-03,
9.7840E-03,-5.4155E-04,-1.2777E-02,9.7816E-03,1.0191E-02,-2.0357E-02,
7.5528E-04,2.7078E-02,-2.0524E-02,-2.2887E-02,4.6306E-02,-9.1646E-04,
-7.2377E-02,6.1729E-02,9.1822E-02,-3.0226E-01,4.0097E-01,-3.0226E-01,
9.1822E-02,6.1729E-02,-7.2377E-02,-9.1646E-04,4.6306E-02,-2.2887E-02,
-2.0524E-02,2.7078E-02,7.5528E-04,-2.0357E-02,1.0191E-02,9.7816E-03,
-1.2777E-02,-5.4155E-04,9.7840E-03,-4.7459E-03,-4.7123E-03,5.9299E-03,
3.3179E-04,-4.4292E-03,2.0431E-03,2.0642E-03,-2.4630E-03,-1.6787E-04,
1.7367E-03,-7.4799E-04,-7.5418E-04,8.3453E-04,6.4783E-05,-5.2359E-04,
2.0192E-04,1.9260E-04,-1.8376E-04,-1.4254E-05,7.9458E-05,-2.1534E-05,
-1.2698E-05,4.1111E-06,-1.3513E-20
};
#endif



float h[N] = {
-2.6357E-07,-1.5182E-04,1.1880E-03,1.1163E-03,-4.3980E-04,2.9022E-07,
2.9960E-04,-2.3412E-03,-2.3715E-03,9.1539E-04,-3.9820E-07,-6.9734E-04,
4.9920E-03,5.0893E-03,-1.8327E-03,4.6882E-07,1.4815E-03,-9.6654E-03,
-9.8899E-03,3.3246E-03,-4.4526E-07,-2.8775E-03,1.7309E-02,1.7936E-02,
-5.6781E-03,3.3215E-07,5.3716E-03,-3.0266E-02,-3.2210E-02,9.7433E-03,
-1.7841E-07,-1.0473E-02,5.6907E-02,6.4290E-02,-1.9370E-02,4.9746E-08,
2.7230E-02,-1.6252E-01,-2.4281E-01,1.1674E-01,4.0061E-01,1.1674E-01,
-2.4281E-01,-1.6252E-01,2.7230E-02,4.9746E-08,-1.9370E-02,6.4290E-02,
5.6907E-02,-1.0473E-02,-1.7841E-07,9.7433E-03,-3.2210E-02,-3.0266E-02,
5.3716E-03,3.3215E-07,-5.6781E-03,1.7936E-02,1.7309E-02,-2.8775E-03,
-4.4526E-07,3.3246E-03,-9.8899E-03,-9.6654E-03,1.4815E-03,4.6882E-07,
-1.8327E-03,5.0893E-03,4.9920E-03,-6.9734E-04,-3.9820E-07,9.1539E-04,
-2.3715E-03,-2.3412E-03,2.9960E-04,2.9022E-07,-4.3980E-04,1.1163E-03,
1.1880E-03,-1.5182E-04,-2.6357E-07
};





/**
  * @brief  TFIRFiltre_Init
  * @retval
  */
void FIRFiltre_Init(FIRFiltre *fir)
{

	for (uint8_t n=0; n<FIR_FILTRE_LENGTH; n++)
	{
		fir->buf[n]=0.0f;
	}


	/*set buffer index */
	fir->bufIndex = 0 ;

	/*Clear output */

	fir->out = 0.0f;

#ifdef MOVING_AVG_FILRE
	/*Init h[n] Moving avearge Filtre*/
	for (uint8_t n=0;n<FIR_FILTRE_LENGTH ;n++)
	{
		FIR_IMPULSE_RESPONSE[n] = (float)1/(float)FIR_FILTRE_LENGTH;
	}

#endif


}

/**
  * @brief  FIRFiltre_Update
  * @retval int
  */
float FIRFiltre_Update(FIRFiltre *fir, float inp)
{

  /*Store latest sample in buffer*/
   fir->buf[fir->bufIndex] = inp;

   /*Increment Buff indew and wrap arround if necessary */
   if (fir->bufIndex<FIR_FILTRE_LENGTH)
   {
	   fir->bufIndex++;
   }
   else
   {
	   fir->bufIndex=0.0f;
   }

   /*Compute new output sample (via convulation) */
   fir->out=0.0f;


   uint8_t sumIndex=fir->bufIndex;


	for (uint8_t n=0; n<FIR_FILTRE_LENGTH; n++)
	{
		/*Decrement index and wrap if necessary  */
		if (sumIndex>0)
		{
			sumIndex--;
		}
		else
		{
			sumIndex=FIR_FILTRE_LENGTH-1U;

		}
		/*Multiply impulse reponse with shifted sample and add to output*/

#ifdef MOVING_AVG_FILRE
		fir->out += FIR_IMPULSE_RESPONSE[n] * fir->buf[sumIndex];

#else
		fir->out += h[n] * fir->buf[sumIndex];

#endif

	}

   return fir->out;



}









/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/
